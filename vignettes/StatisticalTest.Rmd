---
title: "Statistical testing of quantitative omics data"
author: "Veit SchwÃ¤mmle"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

Welcome to the vignette of the PolySTest package. We will run statistical tests for differential abundances in a proteomics data set. 

## Installation

To install PolySTest, you can use Bioconductor's BiocManager:

```{r, eval=FALSE}
if (!requireNamespace("BiocManager", quietly = TRUE))
    install.packages("BiocManager")

BiocManager::install("PolySTest")
```

## Loading data
First, we load the necessary package and example data and reduce it to 200
lines. The data set consists of protein abundances in liver samples from mice
fed with four different diets. The data contains 3 replicates per diet.

```{r}
library(PolySTest)

# Load the data file "LiverAllProteins.csv" from the PolySTest package
filename <- system.file("extdata", "LiverAllProteins.csv", package = "PolySTest")

dat <- read.csv(filename, row.names=1, stringsAsFactors = FALSE)
dat <- dat[1:200,] # Use a subset of the data for this example
```

## Creating a SummarizedExperiment object
We now create a `SummarizedExperiment` object from the data. This object will
contain the protein abundances and the sample metadata.

In addition, we normalize by the median of the columns to adjust for differences
in the sample amounts loaded into the instrument.

```{r}


sampleMetadata <- data.frame(Condition = rep(paste("Condition", 1:4), each=3),
                             Replicate = rep(1:3, each=4))

fulldata <- SummarizedExperiment(assays = list(quant = dat), colData = sampleMetadata)
metadata(fulldata) <- list(NumReps = 3, NumCond = 4)

# Normalization (example)
dat <- t(t(dat) - colMedians(as.matrix(dat), na.rm = TRUE))
assay(fulldata, "quant") <- dat

fulldata <- update_conditions_with_lcs(fulldata)
```

## Defining comparisons
We define the comparisons we want to test. In this case, we want to compare
each condition with each other condition. We use the `create_pairwise_comparisons`
function to create a matrix of all pairwise comparisons.

```{r}
conditions <- unique(colData(fulldata)$Condition)
allComps <- create_pairwise_comparisons(conditions, 2)

allComps
```

## Running the statistical tests
We can now run the statistical tests. We will use the `PolySTest_paired` function
to run paired tests. The function will add columns to the `rowData` of the
`SummarizedExperiment` object containing the p-values and FDRs for each comparison.

```{r}
fulldata <- PolySTest_paired(fulldata, allComps)
rowData(fulldata)

```

## Running unpaired tests
We can also run unpaired tests using the `PolySTest_unpaired` function. The 
experimental design dictated whether to use paired or unpaired tests.

```{r}
fulldata <- PolySTest_unpaired(fulldata, allComps)
rowData(fulldata)

```

## Session info
```{r}
sessionInfo()

```
